# Figsiner — Phase-1 (Section Generator/Editor) Dev Plan

**Goal:** Generate and edit a single **section** in Figma based on a natural-language prompt, using **Material 3** components when available (via `componentKey`) or wireframe primitives as fallback. Output both **desktop (1920→container 1200)** and **mobile (420)** variants in one run. “Edit” is **patch-only**.

## 0) Constraints / Design Foundations
- **Viewports:** desktop 1920 (container 1200), mobile 420
- **Auto Layout:** always; no absolute positioning
- **Columns rule:** mobile 1–2, desktop 3–5 (prefer 3 for features/pricing)
- **Spacing:** even integers only; section padding 24–40; item spacing 8–24
- **Radii:** { sm:4, md:8, lg:12, xl:16 }
- **Type:** { h1:36, h2:28, h3:22, body:16, small:14 }
- **Material 3 library:** duplicated to team, **published** and enabled for your account
- **Model settings (default):** temp 0.0, input ~12k, output ~2k

## 1) Repo Structure (targets)
```
Figsiner/
  manifest.json
  src/
    plugin.ts
    ui.html
    ui.ts
    renderer/
      render-section.ts        # create/update nodes
      component-instance.ts    # import by key
      primitive-builders.ts
      patch-applier.ts
    schemas/
      section.schema.json
      section.patch.schema.json
  prompts/
    section-generate.txt
    section-edit.txt
  tokens/
    design-tokens.json
    design-rules.md
  catalog/
    component-catalog.json     # generated by exporter
  docs/
    plan/
      phase1-section-engine.md # (this file)
      checklist.md
  ops/
    checklist.yaml
  tools/
    export-keys-dev-plugin/    # tiny local plugin to dump component keys
  vite.config.ts
  package.json
  README.md
```

## 2) Phase-1 Features
- **Settings view:** user enters API host, API key, model; Verify via `/models`; persist locally.
- **Generate Section:**  
  - If **empty frame** selected → create section (desktop+mobile variants).  
  - If **no selection** → create a new “Section — {timestamp}” frame.  
- **Edit Section (patch-only):**  
  - If **section frame selected** → send CURRENT_SECTION JSON + user brief → apply **patch ops**.
- **Library components:** prefer `componentKey` if present; else primitives.

## 3) JSON Schemas
- `schemas/section.schema.json` — one **section** + items (or `useComponent` blocks)
- `schemas/section.patch.schema.json` — list of **ops** (`updateSection`, `replaceItemText`, `insertItem`, `removeItem`, etc.)
- Dual-viewport wrapper at response top:
```json
{
  "meta": { "schema": "section-1.0-multi" },
  "variants": [
    { "viewport": "desktop", "section": { ... } },
    { "viewport": "mobile",  "section": { ... } }
  ]
}
```

## 4) Prompts (system templates)
- `prompts/section-generate.txt` — strict JSON only, tokens/rules enforced, prefer Material `componentKey`, else primitives; return **both viewports**.
- `prompts/section-edit.txt` — input includes `CURRENT_SECTION` JSON + `EDIT_BRIEF` → return **patch ops** JSON only (no prose).

## 5) Renderer Responsibilities
- Load fonts (`Inter`/`Roboto`) before text operations
- Create/locate target frame(s) (desktop & mobile)
- Apply Auto Layout, padding, item spacing from tokens
- **Instance components** with `figma.importComponentByKeyAsync(key)` when `useComponent` present
- **Primitives** fallback (text/rect/image/button/input)
- Apply **patch ops** deterministically; clamp any non-token values to nearest valid token
- Keep section node naming: `Section • {type} • {viewport}`

## 6) Material Library Catalog (component keys)
- Use `tools/export-keys-dev-plugin` to enumerate published components → output `catalog/component-catalog.json` with:
```json
[
  { "name": "Button/Filled", "componentKey": "REPLACE", "variants": { "Size": ["Small","Medium","Large"], "State": ["Enabled","Hover","Pressed"] } },
  { "name": "Text field/Outlined", "componentKey": "REPLACE", "variants": { "State": ["Enabled","Error"] } },
  { "name": "Card/Elevated", "componentKey": "REPLACE" }
]
```
- Keep this small for P1 (buttons, text fields, cards). Expand later.

## 7) Security & Secrets
- **Local dev only**: store API host/key in `figma.clientStorage` + UI `localStorage`.
- **Future prod**: add a backend token exchange; encrypt at rest. (Toggle in Settings later.)

## 8) Definition of Done (P1)
- Settings verify works against `/models`
- Generate Section into empty frame: **Hero**, **Features**, **Pricing**, **FAQ** all pass visual smoke test
- Edit Section: change columns, replace button label, insert/remove item — all succeed
- Material components instantiate when requested; fallback primitives otherwise
- JSON errors surface helpful message; renderer clamps to tokens; no crashes

---

## Implementation Steps (for Codex)

### A. Scaffolding
- [ ] Create `manifest.json` (main: `dist/plugin.js`, ui: `dist/ui.html`, allowedDomains `*`)
- [ ] Vite build to produce `dist/plugin.js` + `dist/ui.html`
- [ ] `src/plugin.ts`: show UI, handle messages (`SAVE_SETTINGS`, `REQUEST_SETTINGS`, `GENERATE_SECTION`, `EDIT_SECTION`)
- [ ] `src/ui.html` + `src/ui.ts`: Settings + Generate/Edit modes, textarea prompt, verify button

### B. Tokens & Rules
- [ ] Add `tokens/design-tokens.json` with provided values
- [ ] Add `tokens/design-rules.md` bullets
- [ ] Utility: `getToken(value, type)` to clamp to nearest token

### C. Schemas & Prompts
- [ ] Write `schemas/section.schema.json`
- [ ] Write `schemas/section.patch.schema.json`
- [ ] Create `prompts/section-generate.txt` (dual-viewport)
- [ ] Create `prompts/section-edit.txt` (patch ops only)

### D. Catalog (Material)
- [ ] Build `tools/export-keys-dev-plugin`:
  - Enumerate components in the **published Material library** file
  - Output `catalog/component-catalog.json` (name, key, variants)
- [ ] In renderer, add `importComponentByKeyAsync(key)` helper

### E. Renderer
- [ ] `renderer/primitive-builders.ts` — text/rect/image/button/input helpers
- [ ] `renderer/component-instance.ts` — instance Material components, set variants if provided
- [ ] `renderer/render-section.ts` — build a section frame from Section JSON
- [ ] `renderer/patch-applier.ts` — apply ops to selected section

### F. Generate Flow
- [ ] UI sends `{ prompt, model, host, key }` to backend `/chat/completions` with **system prompt**
- [ ] Parse JSON (array of 2 variants). Validate vs schema; clamp to tokens
- [ ] Create/locate frames: Desktop 1920/1200 container; Mobile 420
- [ ] Call `render-section` twice → notify

### G. Edit Flow (Patch)
- [ ] Snapshot CURRENT_SECTION (minimal JSON)
- [ ] Send to model with `EDIT_BRIEF`
- [ ] Parse patch ops; validate vs patch schema
- [ ] Apply ops on selected section

### H. Error Handling
- [ ] If JSON invalid → show excerpt + “Regenerate” CTA
- [ ] If component import fails → fallback primitive
- [ ] If font load fails → retry with `Roboto` then continue

### I. QA Scenarios
- [ ] Generate hero (desktop+mobile)
- [ ] Edit hero: change H1 and CTA label
- [ ] Features: 2→3 columns desktop
- [ ] Pricing: three tiers + CTA
- [ ] FAQ: 4 items
- [ ] No selection in Edit → guard message

---

## Checklists (human + machine)

### docs/plan/checklist.md
- [ ] Settings verify against `/models`
- [ ] Section schema ready
- [ ] Patch schema ready
- [ ] Generate prompt template ready
- [ ] Edit prompt template ready
- [ ] Renderer (primitives)
- [ ] Renderer (component instances)
- [ ] Export keys dev plugin
- [ ] Desktop+Mobile dual variant output
- [ ] QA: hero/features/pricing/faq
- [ ] Error handling & notifications
- [ ] README updated

### ops/checklist.yaml
```yaml
phase: "P1"
items:
  - id: settings-verify
    title: "Settings: Verify /models"
    status: todo
  - id: schema-section
    title: "Section schema"
    status: todo
  - id: schema-patch
    title: "Patch schema"
    status: todo
  - id: prompt-generate
    title: "Prompt: Generate Section"
    status: todo
  - id: prompt-edit
    title: "Prompt: Edit Section"
    status: todo
  - id: renderer-primitives
    title: "Renderer: primitives"
    status: todo
  - id: renderer-components
    title: "Renderer: component instances"
    status: todo
  - id: tool-export-keys
    title: "Dev tool: export Material component keys"
    status: todo
  - id: dual-viewport
    title: "Dual output (desktop+mobile)"
    status: todo
  - id: qa-suite
    title: "QA scenarios pass"
    status: todo
  - id: errors
    title: "Error handling & toasts"
    status: todo
  - id: readme
    title: "README"
    status: todo
```

---

## Prompts (headers to drop into `prompts/`)

**`prompts/section-generate.txt` (excerpt)**
```
You are a Section Layout Engine for Figma. Return STRICT JSON only.
Produce BOTH desktop (container 1200 within 1920) and mobile (420) using tokens/rules.
Prefer published Material components via componentKey; else primitives.

INPUTS:
- USER_BRIEF: <<<{user_brief}>>>
- DESIGN_TOKENS: <<<contents of tokens/design-tokens.json>>>
- DESIGN_RULES: <<<contents of tokens/design-rules.md>>>
- COMPONENT_CATALOG: <<<contents of catalog/component-catalog.json>>>

OUTPUT:
{
  "meta": { "schema": "section-1.0-multi" },
  "variants": [
    { "viewport": "desktop", "section": { ... } },
    { "viewport": "mobile",  "section": { ... } }
  ]
}
JSON only. No prose.
```

**`prompts/section-edit.txt` (excerpt)**
```
You edit an EXISTING section. Return STRICT JSON patch ops only.

INPUTS:
- CURRENT_SECTION (JSON): <<<{current_section_json}>>>
- EDIT_BRIEF (text): <<<{edit_brief}>>>
- DESIGN_TOKENS: <<<tokens JSON>>>
- DESIGN_RULES: <<<rules>>>

OUTPUT:
{
  "meta": { "schema": "section-patch-1.0" },
  "ops": [ ... ]
}
```

---

## Notes for Codex (how it “understands → browses → updates”)

- **Read plan** from `docs/plan/phase1-section-engine.md`
- **Read checklist** from `ops/checklist.yaml`
- **Execute tasks** in the order of **Implementation Steps**
- **Flip statuses** in `ops/checklist.yaml` from `todo` → `doing` → `done`
- **Mirror progress** in `docs/plan/checklist.md` checkboxes
- **Commit** with messages like: `feat(renderer): add primitive builders (refs #renderer-primitives)`
